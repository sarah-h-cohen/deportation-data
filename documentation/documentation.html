<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.22">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sarah Cohen">
<meta name="dcterms.date" content="2025-10-14">

<title>Overview notes on Big Local Deportation Data project</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="documentation_files/libs/clipboard/clipboard.min.js"></script>
<script src="documentation_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="documentation_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="documentation_files/libs/quarto-html/popper.min.js"></script>
<script src="documentation_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="documentation_files/libs/quarto-html/anchor.min.js"></script>
<link href="documentation_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="documentation_files/libs/quarto-html/quarto-syntax-highlighting-7b4406b7675125bc2ba204020e191172.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="documentation_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="documentation_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="documentation_files/libs/bootstrap/bootstrap-756b2afc403d436000bcb0911942e956.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#immigration-data-projects-in-the-wild" id="toc-immigration-data-projects-in-the-wild" class="nav-link active" data-scroll-target="#immigration-data-projects-in-the-wild">Immigration data projects in the wild</a>
  <ul class="collapse">
  <li><a href="#deportation-data-project" id="toc-deportation-data-project" class="nav-link" data-scroll-target="#deportation-data-project">Deportation Data Project</a></li>
  <li><a href="#follow-up-from-symposium-of-reporters" id="toc-follow-up-from-symposium-of-reporters" class="nav-link" data-scroll-target="#follow-up-from-symposium-of-reporters">Follow up from symposium of reporters</a></li>
  <li><a href="#guardian-us" id="toc-guardian-us" class="nav-link" data-scroll-target="#guardian-us">Guardian US</a></li>
  <li><a href="#enforcement-dashboard" id="toc-enforcement-dashboard" class="nav-link" data-scroll-target="#enforcement-dashboard">Enforcement dashboard</a></li>
  <li><a href="#other-possible-sources" id="toc-other-possible-sources" class="nav-link" data-scroll-target="#other-possible-sources">Other possible sources</a></li>
  </ul></li>
  <li><a href="#datasets" id="toc-datasets" class="nav-link" data-scroll-target="#datasets">Datasets</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Overview notes on Big Local Deportation Data project</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sarah Cohen </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 14, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="confidential">
<p>NOT FOR PUBLICATION</p>
</div>
<section id="immigration-data-projects-in-the-wild" class="level2">
<h2 class="anchored" data-anchor-id="immigration-data-projects-in-the-wild">Immigration data projects in the wild</h2>
<section id="deportation-data-project" class="level3">
<h3 class="anchored" data-anchor-id="deportation-data-project">Deportation Data Project</h3>
<p>The <a href="https://deportationdata.org/index.html">Deportation data project</a> is run by Graeme Blair of UCLA and David Hausman of Berkeley Law. Together, they’ve sued DHS to obtain individual-level data from ICE and CBP about encounters, arrests, detainers, detentions and removals. So far it doesn’t seem that they’ve gotten much from CBP, but they have obtained the data from ICE. It gets updated irregularly, most recently in September 2025 for data ending in July.</p>
<p>We spoke with Hausman in September, who told us a bit about the project and about some of the uses for his data. In particular, he said that news organizations had done a good job using local arrest data, for what it’s worth, but that the others take some decision-making and are a little harder. In his view, the detention data would have the most use for local reporters and is the most under-used.</p>
<p>Graeme is undertaking a project to make LIONS more accessible to researchers and reporters – I’ve had one interaction with him but didn’t hear back after I responded to his message.</p>
<p>The project is currently setting up “slicers” for their data, but is not really trying to make it more accessible than that. Hausman said he would welcome any help we can give in helping reporters use it – they are getting a lot of questions and requests for help, and they can’t handle it all. They need this help more than any technical help.</p>
<p>We talked with them about how Big Local could help fill that void.</p>
<p>They have <a href="https://deportationdata.org/docs/ice/codebook.html">excellent documentation</a> of the terms used in deportation datasets - it’s a great guide to what we know and what we don’t about the data.</p>
</section>
<section id="follow-up-from-symposium-of-reporters" class="level3">
<h3 class="anchored" data-anchor-id="follow-up-from-symposium-of-reporters">Follow up from symposium of reporters</h3>
<p>In June, Berkeley Journalism and a few other places <a href="https://docs.google.com/document/d/1TOFnulRtde2uO2xGK-ln0MYpgEZZzGDqsGoJSX6GeMU/edit?usp=sharing">hosted a symposium</a> of reporters, experts, etc. to discuss immigration reporting. Our contact there is Andrés Cediel, a documentarian with a lot of interest in immigration issues. We spoke with him on Oct 10. They want to make the data more transparent, and are focused on visualizations that could be embedded. Others who are still involved include Mark Lima of CBS and (I think) Lourdes Duarte from Chicago WGN.</p>
<p>Their inspiration was the COVID tracking project from the Atlantic.</p>
<p>His story ideas were pretty straightforward: US citizens getting caught up in raids, looking at children , those without criminal records. They are working with the Berkeley-based California News Fellowship (the group that is funded by the Calif. government to fill holes in local reporting.)</p>
<p>Ryan explained our model of working with a national outlet to do a story that we can help get localized by partners that we’ve worked with before, then have training materials, cleaned data, etc. to provide to anyone once we know what we’re doing. In a followup note, Andrès still seemed focused on dashboard / visualizations, but Ryan clarified that.</p>
<p>He mentioned that LAT did a good job using the data after their protests.</p>
</section>
<section id="guardian-us" class="level3">
<h3 class="anchored" data-anchor-id="guardian-us">Guardian US</h3>
<p>Will Craft, who has done a lot of work with Big Local in the past, is using the Deportation Data project pretty effectively, and is interested in being our national partner. We’re scheduled to talk with him next week.</p>
</section>
<section id="enforcement-dashboard" class="level3">
<h3 class="anchored" data-anchor-id="enforcement-dashboard">Enforcement dashboard</h3>
<p>The <a href="https://austinkocher.substack.com/p/live-new-immigration-enforcement">immigration enforcement dashboard</a> was initialy released in September, but includes only arrest data for the time being. The project is led by <a href="https://austinkocher.com/">Austin Kocher</a> an asst. research professor at Syracuse Journalism in the Office of Research and Creative Technology.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>There is a proof of concept at <a href="https://enforcementdashboard.com/ice-arrests/" class="uri">https://enforcementdashboard.com/ice-arrests/</a> for arrests, but it’s unclear if they are going beyond that. It’s done by Kocher’s company, Relevant Research, which also has a site called <a href="https://detentionreports.com" class="uri">https://detentionreports.com</a>. His numbers in detention can’t be separately sourced because he is using an imputation method to convert year-to-date averages into daily populations by month.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<p>He has gotten historical numbers by week by going to the wayback machine. ICE takes down the old links, but WAYBACK has them</p>
<p>On <a href="https://austinkocher.substack.com/" class="uri">https://austinkocher.substack.com/</a> , he has done some work explaining what is in the data and what isn’t.</p>
<p>The enforcement dashboard has some issues with functionality – my guess is that although the concept worked for aggregated stats that are in the ICE detention data, it doesn’t work for datasets with way more values in it.</p>
</section>
<section id="other-possible-sources" class="level3">
<h3 class="anchored" data-anchor-id="other-possible-sources">Other possible sources</h3>
<section id="interest-groups" class="level4">
<h4 class="anchored" data-anchor-id="interest-groups">Interest groups</h4>
<ul>
<li>Cato Institute, immigration project. It’s unclear who we’d want to speak with - they have several people writing articles, including Scott Lincicome and David J. Bier. Bier published <a href="https://www.cato.org/blog/ice-arresting-1100-percent-more-noncriminals-streets-2017">at least one article</a> referencing “nonpublic data” acquired by Cato that isn’t anywhere else.</li>
</ul>
</section>
<section id="reporters" class="level4">
<h4 class="anchored" data-anchor-id="reporters">Reporters</h4>
<ul>
<li><p>LA Times reporters who have been working with all of the data</p></li>
<li><p>Tim Henderson, Stateline</p></li>
</ul>
</section>
</section>
</section>
<section id="datasets" class="level2">
<h2 class="anchored" data-anchor-id="datasets">Datasets</h2>
<p>The original data was downloaded from the Deportation Data Project, as of Oct.&nbsp;13, 2025 (the date of this documentation). I’ll update it when they get a new batch. I downloaded the original, not cleaned, data.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">All datasets</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>The deportation data project posts five datasets: encounters, arrests, detainers, detentions, and removals. They each have their own issues, but some cross all of the datasets. They also have a list of detention sites that can be used for mapping.</p>
<p>In the <code>data/raw</code> folder, I’ve made an exact copy of the data that the project posts. (Most recent in most cases.) There is also a copy that I can use for hand-editing, with more descriptive data names. That’s in the <code>data/processed</code> folder, even though it’s raw.</p>
<p>The project is pretty good about doing basic vetting of the datasets when they arrive. For example, it immediately post the removals data from July, when they found a serious flaw. They also post when each dataset is usable as history.</p>
<p>The data originally is extracted from DHS’s Enforcement Integrated Database, or EID, which is the back end to the department’s ENFORCE application. It’s supposed to hold details on the entire enforcement infrastructure, and is supposed to contain information from all of the enforcement agencies (I think).</p>
<p>There are some things to remember about all of the datasets, and some specific to individual ones.</p>
<p>Outstanding questions are shown in a callout under each section.</p>
<p>There are some definitions that are still meaningful in the paper “<a href="https://journals.sagepub.com/doi/reader/10.1177/233150241500300402">Piecing together the US Immigration Detention Puzzle One Night at a Time</a>, Donald Kerwin and Daniela Alulema (Center for Migration Studies), Journal on Migration and Human Security, 2012.</p>
<section id="most-serious-crime-categories" class="level3">
<h3 class="anchored" data-anchor-id="most-serious-crime-categories">Most serious crime categories</h3>
<p>It’s really unclear what they are using as the “most serious” crime category for the purpose of deportation. There are a couple of documents that can help:</p>
<ol type="1">
<li><p>TRAC, at some point, <a href="https://tracreports.org/immigration/reports/330/include/DocumentReleased_13-15734_Criminal_Offense_Level_Business_Rules.pdf">got a list of offense codes from DHS</a> that lists the ‘level’ of each crime, as 1, 2, or 3. We can see there that illegal entry to the US is the lowest crime category. But it doesn’t really help within the levels. (These were based on the old Morton memo, and haven’t been in use for a long time, I don’t think.)</p></li>
<li><p>The [American Immigration Council examined the “Most serious charge”]https://www.americanimmigrationcouncil.org/wp-content/uploads/2025/01/enforcement_overdrive_a_comprehensive_assessment_of_ices_criminal_alien_program_final.pdf) in the Criminal Alien Program that gives some detail on what they consider more and less serious.</p></li>
</ol>
<p>Also from the American Immigration Council:</p>
<div class="blockquote">
<p>“Aggravated felony” is a term of art used to describe a category of offenses carrying particularly harsh immigration consequences for noncitizens convicted of such crimes. Regardless of their immigration status, noncitizens who have been convicted of an “aggravated felony” are prohibited from receiving most forms of relief that would spare them from deportation, including asylum, and from being readmitted to the United States at any time in the future.</p>
<p>Despite what the ominous-sounding name may suggest, an “aggravated felony” does not require the crime to be “aggravated” or a “felony” to qualify. Instead, an “aggravated felony” is simply an offense that Congress sees fit to label as such, and today includes many nonviolent and seemingly minor offenses.</p>
<p>…</p>
<p>As initially enacted in 1988, the term “aggravated felony” referred only to murder, federal drug trafficking, and illicit trafficking of certain firearms and destructive devices. Congress has since expanded the definition of “aggravated felony” on numerous occasions, but has never removed a crime from the list. Today, the definition of “aggravated felony” covers more than thirty types of offenses, including simple battery, theft, filing a false tax return, and failing to appear in court.</p>
</div>
<p><a href="https://www.uscis.gov/policy-manual/volume-12-part-f-chapter-4">USCIS has a list of aggravated felonies</a> on its website, but I’m not sure how up to date it is.</p>
<p>You can also be deported for crimes of “moral turpitude”.</p>
<p>(The reason this matters is that it goes into the “most serious” crime category, I think.)</p>
<p>The ICE custody worksheet suggests that the most serious crime conviction is based on the sentence, and nothing else: https://www.ice.gov/doclib/detention-standards/2011/2-2.pdf</p>
</section>
<section id="duplications" class="level3">
<h3 class="anchored" data-anchor-id="duplications">Duplications</h3>
<p>There are apparent duplications in each dataset. Some are not truly dupes but are different events. For example, a single person arrested can have a series of detention records as they are moved around by ICE. Some are just mysterious. I’m handling different situations in different ways, documented here.</p>
</section>
<section id="missing-unique-identifiers" class="level3">
<h3 class="anchored" data-anchor-id="missing-unique-identifiers">Missing unique identifiers</h3>
<p>ICE is supposed to provide a scrambled unique identifier for each person but there are quite a few missing.</p>
</section>
<section id="famous-cases" class="level3">
<h3 class="anchored" data-anchor-id="famous-cases">Famous cases</h3>
<div class="todo">
<ul class="task-list">
<li><label><input type="checkbox">Get a list of famous cases that should be followed through the system</label>
<ul>
<li>Moving around detention</li>
<li>Arrest at courthouse</li>
<li>US citizens</li>
<li>Deaths</li>
<li>Children</li>
</ul></li>
</ul>
</div>
<div class="question">
<ul class="task-list">
<li><label><input type="checkbox">Is the unique identifier the same over time?</label></li>
<li><label><input type="checkbox">What is the impact of this coming from ICE’s Integrated Enforcement Database? Is any CBP data included? Should it be?</label></li>
</ul>
</div>
</section>
</div>
</div>
</div>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>These are usually grant management divisions of schools, and there is nothing about it in the Newhouse School’s website. So it’s really unclear whether he works there or not. He’s associated with Margaret Talev’s group as well. Although he says he has a lot of research and media outlet work, it seems really out of date – CSpan last year, and then nothing after 2022. He worked at TRAC while getting his PhD in geography.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>He starts with the <a href="https://www.ice.gov/detain/detention-management">facilities report</a> published by ICE bi-monthly, then <a href="https://relevant-research.com/assets/pdf/methodology_writeup.pdf">calculates an “Interval”</a> value. He takes a whole paper to say that he estimates the most recent two weeks’ values by backing out the number of days. (ADP is calculated as total pop / total # days for the fiscal year. Taking two time periods, can back out an ADP for the two weeks by taking ADP<em>Days period 1 - ADP</em> Days period 2 to get Days for Period 2, and then divide by the number of days.)<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>