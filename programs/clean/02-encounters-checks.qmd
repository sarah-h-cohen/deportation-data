---
author: Sarah Cohen
date: last-modified
title: Arrest table cleanup
subtitle: ""
format:
  scdefault-html:
    code-fold: show
    toc: false
execute:
  echo: fenced
  warning: true
  message: true
  error: true
  cache: false
  eval: true

engine: knitr
---

The `encounters` table is supposed to log each encounter with a person that ICE suspects, but it's unclear how complete it is. An encounter could mean a lot of things -- the most frequent is a fingerprint match with a local jail. But it can also mean street encounters. It's important to remember that an encounter might not be of someone who tells the truth or someone who is known to ICE.

It appears to be of less use on its own than as part of a case contiuum. There's very little geographic detail, making it more interesting to trace cases through the system than to produce stories on its own.
(At a national level, could have information for people who were NOT detained , arrested or removed, but it's unclear how we'd get to that.)

There are still no US citizens purportedly in this data. The ones that I've found online were people detained not in ICE facilities (or arrested by ICE for immigration violations) but people arrested and put into federal law enforcement faciltities.


```{r}
#| label: setup
#| message: false
#| echo: fenced
#| error: true
#| code-fold: true

# assumes pacman has been installed already



#start with a blank slate

rm (list=ls())

# typical packages
pacman::p_load("tidyverse", "glue", "lubridate", "janitor", "readxl", "here", "googlesheets4")
here::i_am("programs/clean/02-encounters-checks.qmd")


#additional packages here
library(data.table)
# don't use openxlsx -- it doesn't really support the named regions that include tables.
library(openxlsx2)

# when was this last picked up from the Deportation Data Project?
orig_xl_date <- mdy("10/14/2025")
xl_filename <- "data/raw/ddp/2025-ICLI-00019_2024-ICFO-39357_ERO_Encounters_07312025.xlsx"




```

## Read Excel files


```{r}
#| label: get-workbook-only
#| eval: false
#| code-fold: true

# this is slow. But loading the full workbook to get the ranges is also slow. I could
# skip this because i know you skip 6 rows, but ...
wb <- wb_load(here(xl_filename))


```





```{r}
#| label: get-xl-data-frames
#| code-fold: true
#| eval: false

table_ranges <- wb_get_named_regions( wb, tables=TRUE)  |>
  filter ( value == "table") |>
  pull ( name)

dfs <- map ( table_ranges, \(x) wb_to_df (wb, named_region = x))

master_xl_encounters <- dfs |>
  list_rbind() |>
  clean_names() |>
  select ( - c( final_program_group, birth_date, alien_file_number:eid_subject_id)) |>
  # sadly, there is no time element in the event_date or departed_date.
  mutate ( across ( c (event_date, final_order_date), as_date))
  rowid_to_column()

glimpse(master_xl_encounters)


```

```{r}
#| label: save-interim
#| eval: false
#| echo: false

# save this so that I can pick it up again later on. Everything from here above is set to eval: false to speed up rendering

saveRDS(master_xl_encounters, here("data/interim/encounters_xl_tables.RDS"))
rm(list=ls())


```


## Basic cleanup

```{r}
#| label: load-interim-data

master_xl <-
  readRDS(here("data/interim/encounters_xl_tables.RDS"))


```


### Duplicates

I'm not taking out apparent duplicates in this file because so many of them have missing unique identifiers. These encounters can happen en masse, and without the unique ID's we can't distinguish between the same person on the same day, or something else. The arrest analysis suggests this is a bit less of a problem than we'd expect, where only about 5000 rows had no unique identifier.

```{r}
#| label: create-data-table

DT <- copy(full_df)
setDT(DT)
setorderv(DT, c("person_id", "event_date", "orig_row_id"))


```

Here, I check for duplicate types

```{r}
#| label: uniqueid_dupes



# compute dupe_count for each group (adds column by reference, very fast)
DT[, dupe_count := .N, by = .(person_id, apprehension_date)]

# take the last row of each group (because we've ordered the table above)
deduped <- DT[, .SD[.N], by = .(person_id, apprehension_date)]

str(deduped)


```

### Apply lookup tables for simplification


